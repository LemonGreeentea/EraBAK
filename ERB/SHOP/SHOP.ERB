;숍 화면의 처리(공통)

;-------------------------------------------------
;숍 화면 개시시의 처리
;-------------------------------------------------
@EVENTSHOP
;오토 세이브 판정
TFLAG:99 = 1

;정보 표시 대상의 도시를 초기화
SHOWN_CITY = -1

;페이지 번호를 초기화
FLAG:거점페이즈페이지 = 1
FLAG:마지막에실행한커맨드 = FLAG:거점페이즈선택커맨드
;dead 엔딩이라면 돌아온다
;IF FLAG:강제 엔드 플래그 == 1
;	FLAG:강제 엔드 플래그 = 0
;	BEGIN TITLE
;ENDIF

;-------------------------------------------------
;숍 화면의 표시 처리
;-------------------------------------------------
@SHOW_SHOP
;오토 세이브 판정을 해제
TFLAG:99 = 0

;커맨드의 선택 가부 판정 플래그를 클리어
VARSET SHOP_AVAIL, 1

;소지금의 상한 설정
MONEY = LIMIT(MONEY, 0, 9999999999999)

;국가 관계 맵의 작성
CALL TMP_CREATE_RELATION_MAP

;사관의 부대 소속 맵을 작성
CALL TMP_CREATE_IS_FREE_MAP

;사관의 쇼우 평가를 준비
CALL TMP_PREPARE_CHARA_STARS
CALL TMP_PREPARE_COUNTRY_STARS

CALL TMP_CREATE_COUNTRY_NEIBORING_MAP


;무효인 입력시에 소거할 때의 행수
LINES_SHOP = LINECOUNT

CALL SINGLE_DRAWLINE
PRINTFORM  제%@"{DAY}", 3, RIGHT%기　

PRINTBUTTON "[QSAVE]", 94
PRINT 　
CALL PRINTBUTTON_EX("[QLOAD]", 95, CHKDATA(9999) == 0)
PRINT 　

IF TIME == 0
	PRINTBUTTON "<<", 87
	PRINTBUTTON @"[%STR_NOW_SORTKEY:소트키, 4, LEFT%]", 85
	RESETCOLOR
	PRINTBUTTON ">>", 88
	PRINT  
	PRINTBUTTON @"[\@ 내림차순소트 ? 내림차순 # 오름차순\@]", 86
	PRINT   
	PRINTBUTTON "[지도]", 89
	;세로에 늘어놓는 행을 없게 갖추는 편이 어긋나 보이므로 틈새측을 정돈하도록(듯이) 변경
	;최대 13 자리수 칸마 4더해 17
	PRINTFORM  금:\@ STRLENS(TOSTR(MONEY)) > 10 ? %" 100억 이상", 13, LEFT% # %@"%NUM_FORMAT(MONEY)%", 13, LEFT%\@　
	PRINTFORM 함락:%@"%NUM_FORMAT(FLAG:함락인원수)%", 3, LEFT% 
	IF COOLTIME:MASTER:0 >= 2
		CALL COLOR_PRINT(@"쿨타임{COOLTIME:MASTER:0}", 칼라_빨강)
	ELSEIF CFLAG:MASTER:행동불능상태 == 행동불능_임월
		CALL COLOR_PRINT("임월", 칼라_빨강)
	ENDIF
	PRINTFORM  체력:
	CALL PRINT_GRADATIONBAR(BASE:MASTER:체력, MAXBASE:MASTER:체력, 10, 0xFF5E7E, , 1)
	PRINTL 
	;계절과 음력
	IF DISPLAY_SEASON() == "봄"
		PRINT  
		SETCOLOR 0xE597B2
		PRINTFORM %@"%DISPLAY_SEASON(DAY)%의 %DISPLAY_MONTH_OLD(DAY)%", 11, LEFT%
	ELSEIF DISPLAY_SEASON() == "여름"
		PRINT  
		SETCOLOR 0x72AE66
		PRINTFORM %@"%DISPLAY_SEASON(DAY)%의 %DISPLAY_MONTH_OLD(DAY)%", 11, LEFT%
	ELSEIF DISPLAY_SEASON() == "가을"
		PRINT  
		SETCOLOR 0xC53D43
		PRINTFORM %@"%DISPLAY_SEASON(DAY)%의 %DISPLAY_MONTH_OLD(DAY)%", 11, LEFT%
	ELSE
		PRINT  
		SETCOLOR 0x99B3DB
		PRINTFORM %@"%DISPLAY_SEASON(DAY)%의 %DISPLAY_MONTH_OLD(DAY)%", 11, LEFT%
	ENDIF
		RESETCOLOR

	;기후
	IF WEATHERNUM == 기후_맑음
		PRINT  
		SETCOLOR 0xFFAF36
	PRINTFORM %DISPLAY_WEATHER(WEATHERNUM)%
	ELSEIF WEATHERNUM == 기후_구름
		PRINT  
		SETCOLOR 0xB1BFC9
	PRINTFORM %DISPLAY_WEATHER(WEATHERNUM)%
	ELSEIF WEATHERNUM == 기후_강우
		PRINT  
		SETCOLOR 0x3473AC
	PRINTFORM %DISPLAY_WEATHER(WEATHERNUM)%
	ELSE
		PRINT  
		SETCOLOR 0xBAE5E7
	PRINTFORM %DISPLAY_WEATHER(WEATHERNUM)%
	ENDIF
		RESETCOLOR
	PRINT 　

	PRINTFORM %TOSTR_REPEAT("　", 33)%
	IF COOLTIME:MASTER:0 >= 2
		PRINTFORM %TOSTR_REPEAT("　", 3)%
	ELSEIF CFLAG:MASTER:행동불능상태 == 행동불능_임월
		PRINTFORM %TOSTR_REPEAT("　", 2)%
	ENDIF
	PRINTFORM  기력:
	CALL PRINT_GRADATIONBAR(BASE:MASTER:기력, MAXBASE:MASTER:기력, 10, 0x60A74E)
	PRINTFORML  
	DRAWLINEFORM -
ELSE
	IF IS_COUNTRY(CFLAG:MASTER:소속)
		PRINTFORM 금:\@ STRLENS(TOSTR(MONEY)) > 10 ? %" 100억 이상", 13, LEFT% # %@"%NUM_FORMAT(MONEY)%", 13, LEFT%\@
		PRINTFORM 　국고:\@ STRLENS(TOSTR(MONEY:(CFLAG:MASTER:소속))) > 10 ? %"100억 이상", 13, LEFT% # %@"%NUM_FORMAT(MONEY:(CFLAG:MASTER:소속))%", 13, LEFT% \@
		PRINTFORM 　총병수:\@ STRLENS(TOSTR(GET_SUM_SOLDIER(CFLAG:MASTER:소속))) > 6 ? 많음 # %NUM_FORMAT(GET_SUM_SOLDIER(CFLAG:MASTER:소속))% \@
		PRINTFORM 　미할당병수:\@ STRLENS(TOSTR(COUNTRY_SOLDIER:(CFLAG:MASTER:소속))) > 6 ? 많음 # %NUM_FORMAT(COUNTRY_SOLDIER:(CFLAG:MASTER:소속))% \@　
	ELSE
		SIF !FLAG:관전모드
			PRINTFORM 금:%NUM_FORMAT(MONEY)%　
	ENDIF
	LOCALS:0 = 
	SIF DAY < SLG_PP:0
		LOCALS:0 = %LOCALS:0%외교/
	SIF DAY < SLG_PP:1
		LOCALS:0 = %LOCALS:0%군사
	SIF LOCALS:0 != ""
		LOCALS:0 = %LOCALS:0%미해금
	PRINTFORM %LOCALS:0%
	SIF TREATY_U_TARGET:0 != 0
		PRINTFORM %ANAME(GET_COUNTRY_BOSS(TREATY_U_TARGET:0))%토벌 연합
	PRINTL 
	;계절과 음력
	IF DISPLAY_SEASON() == "봄"
		PRINT  
		SETCOLOR 0xE597B2
		PRINTFORM %@"%DISPLAY_SEASON(DAY)%의 %DISPLAY_MONTH_OLD(DAY)%", 11, LEFT%
	ELSEIF DISPLAY_SEASON() == "여름"
		PRINT  
		SETCOLOR 0x72AE66
		PRINTFORM %@"%DISPLAY_SEASON(DAY)%의 %DISPLAY_MONTH_OLD(DAY)%", 11, LEFT%
	ELSEIF DISPLAY_SEASON() == "가을"
		PRINT  
		SETCOLOR 0xC53D43
		PRINTFORM %@"%DISPLAY_SEASON(DAY)%의 %DISPLAY_MONTH_OLD(DAY)%", 11, LEFT%
	ELSE
		PRINT  
		SETCOLOR 0x99B3DB
		PRINTFORM %@"%DISPLAY_SEASON(DAY)%의 %DISPLAY_MONTH_OLD(DAY)%", 11, LEFT%
	ENDIF
		RESETCOLOR

	;기후
	IF WEATHERNUM == 기후_맑음
		PRINT  
		SETCOLOR 0xFFAF36
	PRINTFORM %DISPLAY_WEATHER(WEATHERNUM)%
	ELSEIF WEATHERNUM == 기후_구름
		PRINT  
		SETCOLOR 0xB1BFC9
	PRINTFORM %DISPLAY_WEATHER(WEATHERNUM)%
	ELSEIF WEATHERNUM == 기후_강우
		PRINT  
		SETCOLOR 0x3473AC
	PRINTFORM %DISPLAY_WEATHER(WEATHERNUM)%
	ELSE
		PRINT  
		SETCOLOR 0xBAE5E7
	PRINTFORM %DISPLAY_WEATHER(WEATHERNUM)%
	ENDIF
		RESETCOLOR
	PRINTFORM %TOSTR_REPEAT("　", 2)%
	PRINT 맵 폰트 선택 : 
	PRINTBUTTON "[MS Gothic]", 3990
	PRINT  
	PRINTBUTTON "[굴림체]", 3991
	PRINT  
	PRINTBUTTON "[바탕체]", 3992
	PRINT  
	PRINTBUTTON "[돋움체]", 3993
	PRINT  
	PRINTBUTTON "[궁서체]", 3994
	PRINTL 
	CALL SINGLE_DRAWLINE
ENDIF
;CALL SINGLE_DRAWLINE

;거점 페이즈
IF TIME == 0
	CALL SHOW_SHOP_LIFE
;전략 페이즈
ELSE
	CALL SHOW_SHOP_SLG
ENDIF

REDRAW 0

;-------------------------------------------------
;숍 화면의 입력 처리
;-------------------------------------------------
@USERSHOP
LOCAL:0 = RESULT

REDRAW 1

;거점 페이즈
IF TIME == 0
	CALL USERSHOP_LIFE(LOCAL:0)
;전략 페이즈
ELSE
	CALL USERSHOP_SLG(LOCAL:0)
ENDIF

;처리를 실시하지 않았던 경우
IF !RESULT
	REDRAW 0
	CLEARLINE LINECOUNT - LINES_SHOP
ENDIF

;-------------------------------------------------
;숍 화면에서 0～99가 입력되었을 때의 더미 처리
;-------------------------------------------------
@EVENTBUY
#DIM FIRST_LINE
ITEM:BOUGHT = 0
LOCAL:0 = BOUGHT

REDRAW 1

;거점 페이즈
IF TIME == 0
	CALL EVENTBUY_LIFE(LOCAL:0)
;전략 페이즈
ELSE
	CALL EVENTBUY_SLG(LOCAL:0)
ENDIF

;처리를 실시하지 않았던 경우
IF !RESULT
	;콘피그
	IF LOCAL:0 == 91
		CALL SHOW_CONFIG
	;세이브
	ELSEIF LOCAL:0 == 92
		DUMPRAND
		CALL SAVE_GAME
	;로드
	ELSEIF LOCAL:0 == 93
		CALL LOAD_GAME
	ELSEIF LOCAL:0 == 94
		CALL QUICK_SAVE
		PRINTFORMW 세이브했습니다
		REDRAW 0
		CLEARLINE LINECOUNT - LINES_SHOP
	ELSEIF LOCAL:0 == 95
		CALL QUICK_LOAD
	ELSEIF TIME == 0
		IF LOCAL:0 == 85
			CALL SINGLE_DRAWLINE
			FOR LOCAL, 0, NUM_SORTKEY
				PRINTFORML [{LOCAL}] %STR_NOW_SORTKEY:LOCAL%
			NEXT
			INPUT
			SIF INRANGE(RESULT, 0, NUM_SORTKEY - 1)
				소트키 = RESULT
		ELSEIF LOCAL:0 == 86
			내림차순소트 = !내림차순소트
		ELSEIF LOCAL:0 == 87
			소트키 = ROUND_DECREMENT(소트키, 0, NUM_SORTKEY - 1)
		ELSEIF LOCAL:0 == 88
			소트키 = ROUND_INCREMENT(소트키, 0, NUM_SORTKEY - 1)
		;지도
		ELSEIF LOCAL:0 == 89
			$INPUT_LOOP_SHOP
			FIRST_LINE = LINECOUNT
			FLAG:거점메뉴에서지도표시 = 1
			CALL SINGLE_DRAWLINE
			CALL SET_CITY_COLOR_COUNTRY
			CALL SET_CITY_COLOR_UNIT
			PRINT  맵 폰트 선택 : 
			PRINTBUTTON "[MS Gothic]", 990
			PRINT  
			PRINTBUTTON "[굴림체]", 991
			PRINT  
			PRINTBUTTON "[바탕체]", 992
			PRINT  
			PRINTBUTTON "[돋움체]", 993
			PRINT  
			PRINTBUTTON "[궁서체]", 994
			PRINTL
			CALL DRAWMAP
			CALL RESET_CITY_COLOR
			DRAWLINE
			CALL SHOW_CITY_INFO(SHOWN_CITY)
			SHOWN_CITY = 0
			PRINTL
			PRINTBUTTON "[돌아간다]", 999
			INPUT
			IF RESULT == 990
				맵_폰트 '= "MS Gothic"
			ELSEIF RESULT == 991
				맵_폰트 '= "굴림체"
			ELSEIF RESULT == 992
				맵_폰트 '= "바탕체"
			ELSEIF RESULT == 993
				맵_폰트 '= "돋움체"
			ELSEIF RESULT == 994
				맵_폰트 '= "궁서체"
			ELSEIF RESULT == 999
				FLAG:거점메뉴에서지도표시 = 0
				RETURN
			ENDIF
			LOCAL:1 = RESULT - 1000
			SIF INRANGE(LOCAL:1, 0, MAX_CITY - 1)
				SHOWN_CITY = LOCAL:1
			REDRAW 0
			CLEARLINE LINECOUNT - FIRST_LINE
			GOTO INPUT_LOOP_SHOP
		ELSE
			REDRAW 0
			CLEARLINE LINECOUNT - LINES_SHOP
		ENDIF
	ELSE
		REDRAW 0
		CLEARLINE LINECOUNT - LINES_SHOP
	ENDIF
ENDIF


RETURN